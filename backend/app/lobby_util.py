import random
import string
import time

from backend.app.kitsu_util import *

existing_lobby = {}
default_anime_url = 'https://kitsu.io/anime/fullmetal-alchemist-brotherhood'


def generate_lobby_id(length):
    all_char = string.ascii_letters + string.digits
    random.seed = time.process_time()
    lobby_id = ""
    for x in range(0, length):
        lobby_id = lobby_id + random.choice(all_char)
    return lobby_id


def get_unoccupied_lobby_id(existing_lobby_ids):
    while True:
        lobby_id = generate_lobby_id(8)
        if lobby_id not in existing_lobby_ids:
            existing_lobby_ids[lobby_id] = generate_lobby_dictionary(lobby_id, default_anime_url)
            return lobby_id


def generate_lobby_dictionary(lobby_id, anime_url, *user_ids):
    lobby = {'id': lobby_id, 'anime': get_anime_dictionary_by_url(anime_url)}
    user_list = {}

    user_num = 0
    for uid in user_ids:
        user_list['user' + str(user_num)] = get_user_dictionary_by_name_and_anime_url(uid, anime_url)

    lobby['userList'] = user_list

    return lobby


def set_current_anime(lobby_id, anime_id):
    anime = get_anime_by_url(get_anime_url_by_id(anime_id))
    existing_lobby[lobby_id]['anime'] = get_anime_dictionary_by_anime(anime)


def add_user_to_lobby(lobby_id, username):
    anime_url = get_anime_url_by_id(existing_lobby[lobby_id]['anime']['id'])
    user = get_user_dictionary_by_name_and_anime_url(username, anime_url)
    user_num = len(existing_lobby[lobby_id]['userList'])
    existing_lobby[lobby_id]['userList']['user' + str(user_num)] = user


def remove_user_from_lobby(lobby_id, username):
    anime_url = get_anime_url_by_id(existing_lobby[lobby_id]['anime']['id'])
    users = []
    for u in existing_lobby[lobby_id]['userList']:
        if u['name'] != username:
            users.append(u['id'])
    existing_lobby[lobby_id] = generate_lobby_dictionary(lobby_id, anime_url, users)
