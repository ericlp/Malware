import requests


def get_user_id_by_name(name):
    c = requests.get("https://kitsu.io/api/edge/users?filter[name]=" + name)
    try:
        # establish connection

        if c.status_code == 200:
            return c.json()['data'][0]['id']
    finally:
        c.close()


# returns a list of links to all library entries
ENTRIES_PER_PAGE = 500  # 500 is max


def get_user_library_entries(id):
    c = requests.get(
        "https://kitsu.io/api/edge/users/" + id + "/library-entries?page%5Blimit%5D=500&page%5Boffset%5D=0")
    try:
        if c.status_code != 200:
            return Exception(c.status_code)
        data = c.json()
        count = data['meta']['count']
        entries = []
        for it in range(0, count, ENTRIES_PER_PAGE):
            if it != 0:  # already opened connection for first iteration
                c.close()
                offset = str(it * ENTRIES_PER_PAGE)
                url = "https://kitsu.io/api/edge/users/" + id + "/library-entries?page\%5Blimit%5D=500&page\%5Boffset%5D=" + offset
                c = requests.get()
            for data in c.json()['data']:
                entries.append(data['links']['self'])

        return entries

    finally:
        c.close()


def get_anime_by_entry(data):
    anime_url = data['relationships']['anime']['links']['related']
    anime = requests.get(anime_url)
    try:
        if anime.status_code == 200:
            return anime
    finally:
        anime.close()

def get_title_by_anime(anime):
    try:
        return anime['data']['attributes']['titles']['en']
    except KeyError:
        return anime['data']['attributes']['titles']['en_us']

def get_status_by_entry(data):
    return data['attributes']['status']

def get_progress_by_entry(data):
    return data['attributes']['progress']
